name: Build xopp files into pdf

on:
  workflow_call:
    inputs:
      xopp_directory:
        type: string
        default: '.'
        
      output_directory:
        type: string
        default: 'compiled-pdfs'

      publish_to_branch:
        description: '是否將 PDF 推送到獨立分支 (例如用做備份或 Pages)'
        type: boolean
        default: false
        required: false
      
      publish_branch:
        description: '要推送的目標分支名稱'
        type: string
        default: 'output-pdfs'
        required: false
      
      required_fonts:
        type: string
        default: ''
      
      custom_font_urls:
        description: '字型壓縮檔 (.zip) 的直連網址 (一行一個)'
        default: ''
        required: false
        type: string

permissions:
  contents: write

jobs:
  Build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Downstream (Notes)
        uses: actions/checkout@v4

      - name: Checkout Upstream (Build Tools)
        uses: actions/checkout@v4
        with:
          repository: YFHD-osu/XOPP-Compiler
          path: .build-tools
          ref: main

      - name: Install fonts
        uses: YFHD-osu/XOPP-Compiler/.github/actions/setup-font@main
        with:
          formula_name: ${{ inputs.required_fonts }}
          custom_urls: ${{ inputs.custom_font_urls }}

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives  # 這是 apt 預設存放下載檔的地方
          key: ${{ runner.os }}-apt-xournalpp
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Install Xournal++
        run: |
          sudo apt-get update
          
          sudo apt-get install -y \
            -o Binary::apt::APT::Keep-Downloaded-Packages="true" \
            xournalpp
      
      - name: Run compile script
        run: |
          echo "=== 1. 列出根目錄所有檔案 (包含隱藏檔) ==="
          ls -la
          
          echo "=== 2. 遞迴列出 .build-tools 內的所有檔案 ==="
          # 這行會告訴你 convert.sh 到底躲在哪個子資料夾裡
          ls -R .build-tools
          
          echo "=== 3. 嘗試執行 (修正路徑) ==="
          # 假設它在 scripts 資料夾下 (請根據上面 ls -R 的結果修改這裡)

          bash ${{ github.workspace }}/.build-tools/convert.sh "${{ github.workspace }}/${{ inputs.output_directory }}"

      - name: Deploy to Output Branch
        if: ${{ inputs.publish_branch != '' }}
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ inputs.output_directory }}
          
          publish_branch: ${{ inputs.publish_branch }}
          force_orphan: true
          commit_message: "Deploy compiled PDFs from ${{ github.sha }}"
